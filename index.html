<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Death Melody</title>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js" type="module"></script>
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
  <style>
    body {
      margin: 0; font-family: sans-serif; display: flex; height: 100vh;
    }
    #left, #right {
      width: 50%; padding: 20px; box-sizing: border-box;
    }
    #left {
      background: white;
    }
    #right {
      background: black; color: white; overflow-y: auto;
      font-size: 20px; line-height: 1.4; white-space: pre-wrap;
    }
    .digit { color: white; transition: color 0.2s; }
    .digit.active { color: lime; font-weight: bold; }
    #debugInfo {
      margin-top: 15px; font-size: 14px; color: #333;
    }
    input { padding: 8px; font-size: 16px; width: 100%; margin-bottom: 10px; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

  <div id="left">
    <button id="startButton">Старт</button>
    <div id="formSection" style="display:none;">
      <input id="birthDate" placeholder="Дата рождения (ДД.ММ.ГГГГ)">
      <input id="deathDate" placeholder="Дата смерти (ДД.ММ.ГГГГ)">
      <button id="addButton">Добавить</button>
      <div id="debugInfo">Ожидание начала...</div>
    </div>
  </div>
  <div id="right" id="dateList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7W5jmN8chjqWYrsfFsewNfrp7t0eb-Jk",
      authDomain: "deathmelody.firebaseapp.com",
      databaseURL: "https://deathmelody-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "deathmelody",
      storageBucket: "deathmelody.appspot.com",
      messagingSenderId: "1093758086114",
      appId: "1:1093758086114:web:0b2a22646eac474469a7bb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, 'dates');

    const digitToFreq = {
      0: 32.70, 1: 36.97, 2: 41.24, 3: 45.51, 4: 49.78,
      5: 54.05, 6: 58.32, 7: 62.59, 8: 66.86, 9: 71.13
    };

    const synth1 = new Tone.MonoSynth().toDestination();
    const synth2 = new Tone.MonoSynth().toDestination();

    function randomDelay() {
      return Math.random() * (3.0 - 1.2) * 1000 + 1200;
    }

    function validateDate(input) {
      const regex = /^\d{2}\.\d{2}\.\d{4}$/;
      if (!regex.test(input)) return false;
      const [d, m, y] = input.split(".").map(Number);
      if (m < 1 || m > 12 || d < 1 || d > 31 || y < 1000 || y > 2100) return false;
      return true;
    }

    function formatVisible(d) {
      return d.slice(0, 2) + "." + d.slice(2, 4) + "." + d.slice(4);
    }

    async function playSequence(numbers) {
      for (let digit of numbers) {
        const parsed = parseInt(digit);
        if (isNaN(parsed)) continue;

        const freq = digitToFreq[parsed];
        document.getElementById("debugInfo").textContent = `Сейчас играет: ${digit} → ${freq.toFixed(2)} Гц`;

        const el = document.querySelector(`.digit[data-digit="${digit}"]`);
        if (el) el.classList.add("active");

        synth1.triggerAttackRelease(freq, "8n");
        synth2.triggerAttackRelease(freq, "8n");

        await new Promise(r => setTimeout(r, randomDelay()));

        if (el) el.classList.remove("active");
      }
      await new Promise(r => setTimeout(r, 4200));
    }

    async function loopPlayback(dataArray) {
      while (true) {
        for (let entry of dataArray) {
          const combined = entry.birth + entry.death;
          await playSequence(combined);
        }
      }
    }

    document.getElementById("startButton").addEventListener("click", async () => {
      await Tone.start();
      document.getElementById("startButton").style.display = "none";
      document.getElementById("formSection").style.display = "block";

      onValue(dataRef, async (snapshot) => {
        const container = document.getElementById("right");
        container.innerHTML = "";
        const allData = [];

        snapshot.forEach(child => {
          const val = child.val();
          allData.push(val);
          const birthFormatted = formatVisible(val.birth);
          const deathFormatted = formatVisible(val.death);
          const str = `${birthFormatted} - ${deathFormatted}`;
          const span = document.createElement("div");

          for (let char of str) {
            const spanDigit = document.createElement("span");
            spanDigit.classList.add("digit");
            spanDigit.textContent = char;
            spanDigit.setAttribute("data-digit", char);
            span.appendChild(spanDigit);
          }
          container.prepend(span);
        });

        if (allData.length > 0) loopPlayback(allData);
      });
    });

    document.getElementById("addButton").addEventListener("click", () => {
      const birth = document.getElementById("birthDate").value.replace(/\D/g, "");
      const death = document.getElementById("deathDate").value.replace(/\D/g, "");

      if (birth.length !== 8 || death.length !== 8 || birth >= death) {
        alert("Неверные даты. Проверьте формат и хронологию.");
        return;
      }

      push(dataRef, { birth, death });
      document.getElementById("birthDate").value = "";
      document.getElementById("deathDate").value = "";
    });
  </script>
</body>
</html>
